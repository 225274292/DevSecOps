pipeline {
  agent any
  tools { nodejs 'Node20-LTS' }        
  options { timestamps() }
  triggers { pollSCM('H/5 * * * *') }

  environment {
    FROM       = 'sudhamapippalapalli@gmail.com'                 
    RECIPIENTS = 'sudhamapippalapalli@gmail.com'
  }

  stages {
    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/225274292/DevSecOps.git'
      }
    }

    stage('Install Dependencies') {
      steps {
        bat 'npm install'
      }
    }

    // NEW: authenticate Snyk so `npm test` (snyk test) won’t fail
    stage('Snyk Setup (Auth)') {
      steps {
        withCredentials([string(credentialsId: 'SNYK_TOKEN', variable: 'SNYK_TOKEN')]) {
          bat 'npm install -g snyk'
          bat 'snyk auth %SNYK_TOKEN%'
        }
      }
    }

    stage('Run Tests') {
      steps {
        // keep build green for demo even if snyk finds vulns / exits non-zero
        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
          bat 'npm test'
        }
      }
      post {
        always {
          emailext(
            from: env.FROM,
            to: env.RECIPIENTS,
            subject: "SIT753 – P2T2: Tests ${currentBuild.currentResult} (#${env.BUILD_NUMBER})",
            body: """Job: ${env.JOB_NAME}
Build: #${env.BUILD_NUMBER}
Stage: Run Tests
Console: ${env.BUILD_URL}console""",
            attachLog: true,
            compressLog: true
          )
        }
      }
    }

    stage('NPM Audit (Security Scan)') {
      steps {
        // write JSON report; never fail the build if npm returns non-zero
        bat 'npm audit --json > audit.json || exit /b 0'
        // (optional) also run human-readable audit in console without failing build
        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
          bat 'npm audit'
        }
        archiveArtifacts artifacts: 'audit.json', fingerprint: true, allowEmptyArchive: true
      }
      post {
        always {
          emailext(
            from: env.FROM,
            to: env.RECIPIENTS,
            subject: "SIT753 – P2T2: Security Scan ${currentBuild.currentResult} (#${env.BUILD_NUMBER})",
            body: """Job: ${env.JOB_NAME}
Build: #${env.BUILD_NUMBER}
Stage: NPM Audit (Security Scan)
Console: ${env.BUILD_URL}console""",
            attachLog: true,
            compressLog: true,
            attachmentsPattern: 'audit.json'
          )
        }
      }
    }
  }
}
