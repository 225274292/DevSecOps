pipeline {
  agent any
  tools { nodejs 'Node20-LTS' }
  options { timestamps() }
  triggers { pollSCM('H/5 * * * *') }

  environment {
    RECIPIENTS = 'sudhamapippalapalli@gmail.com'
  }

  stages {
    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/225274292/DevSecOps.git'
      }
    }

    stage('Install Dependencies') {
      steps {
        bat 'npm install'
      }
    }

    stage('Run Tests') {
      steps {
        // Run tests but keep the pipeline going so we always send the email
        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
          bat 'npm test'
        }
      }
      post {
        always {
          emailext(
            to: env.RECIPIENTS,
            subject: "SIT753 – Task 2: Tests ${currentBuild.currentResult} (#${env.BUILD_NUMBER})",
            body: """Job: ${env.JOB_NAME}
Build: #${env.BUILD_NUMBER}
Stage: Run Tests
Console: ${env.BUILD_URL}console""",
            attachLog: true,
            compressLog: true
          )
        }
      }
    }

    stage('Generate Coverage Report') {
      steps {
        // Optional: only if your package.json has a coverage script
        bat 'npm run coverage || exit /b 0'
        archiveArtifacts artifacts: 'coverage*/**/*.*', allowEmptyArchive: true
      }
    }

    stage('NPM Audit (Security Scan)') {
      steps {
        // Save machine-readable report and run readable audit for console
        bat 'npm audit --json > audit.json'
        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
          bat 'npm audit'
        }
        archiveArtifacts artifacts: 'audit.json', fingerprint: true, allowEmptyArchive: true
      }
      post {
        always {
          emailext(
            to: env.RECIPIENTS,
            subject: "SIT753 – Task 2: Security Scan ${currentBuild.currentResult} (#${env.BUILD_NUMBER})",
            body: """Job: ${env.JOB_NAME}
Build: #${env.BUILD_NUMBER}
Stage: NPM Audit (Security Scan)
Console: ${env.BUILD_URL}console""",
            attachLog: true,
            compressLog: true,
            attachmentsPattern: 'audit.json'
          )
        }
      }
    }
  }
}
